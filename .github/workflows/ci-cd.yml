name: Full Stack CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - '.github/**'
      - '.vscode/**'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'README.md'
      - '.github/**'
      - '.vscode/**'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  client-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'client/package-lock.json'

      - name: Install Dependencies
        run: npm install
        working-directory: ./client

      - name: Run Client Unit Tests
        run: npm test -- --watchAll=false
        working-directory: ./client

  build-and-push-all:
    name: Build & Push All Services
    
    needs: [client-tests]
    
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx and Login
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set Image Tags (SHA)
        id: image_tags
        run: echo "SHA_TAG=${{ github.sha }}" >> $GITHUB_OUTPUT
      
      # --- A. Build and Push: CLIENT ---
      - name: Build & Push Client Image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/client
          docker compose build client
          docker tag client:latest $IMAGE:latest
          docker tag client:latest $IMAGE:${{ steps.image_tags.outputs.SHA_TAG }}
          docker push $IMAGE:latest
          docker push $IMAGE:${{ steps.image_tags.outputs.SHA_TAG }}
        
      # --- B. Build and Push: SERVER ---
      - name: Build & Push SERVER Image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/server
          SHA_TAG=${{ steps.image_tags.outputs.SHA_TAG }}

          docker compose build server
          
          docker tag server:latest $IMAGE:latest
          docker tag server:latest $IMAGE:$SHA_TAG
          docker push $IMAGE:latest
          docker push $IMAGE:$SHA_TAG

      # --- C. Build and Push: WORKER ---
      - name: Build & Push Worker Image
        run: |
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/worker
          SHA_TAG=${{ steps.image_tags.outputs.SHA_TAG }}

          docker compose build worker
          
          docker tag worker:latest $IMAGE:latest
          docker tag worker:latest $IMAGE:$SHA_TAG
          docker push $IMAGE:latest
          docker push $IMAGE:$SHA_TAG

      # --- D. Build and Push: NGINX ---
      - name: Build & Push Nginx Image
        run: |
          NGINX_IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/nginx
          SHA_TAG=${{ steps.image_tags.outputs.SHA_TAG }}

          docker compose build nginx
          docker tag nginx:latest $NGINX_IMAGE:latest
          docker tag nginx:latest $NGINX_IMAGE:$SHA_TAG
          docker push $NGINX_IMAGE:latest
          docker push $NGINX_IMAGE:$SHA_TAG